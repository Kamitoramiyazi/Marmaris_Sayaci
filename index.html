<!-- ... (HTML'in üst kısmı ve stil bloğu değişmedi) ... -->
<!-- ... (HTML'in üst kısmı ve stil bloğu değişmedi, en son istediğiniz 'yan yana küçülen' tasarım duruyor) ... -->

<!-- ... <body> ve sayaç kutucukları ... -->

    <!-- Firebase SDK (Gerekli Modüller) -->
    <script type="module">
        // Firebase kütüphanelerini import et
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            setDoc, 
            updateDoc, 
            onSnapshot,
            increment,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DEĞİŞKENLER ---

        // Firebase yapılandırmasını al
        // Sizin tarafınızdan sağlanan Firebase config bilgileri:
        const firebaseConfig = {
          apiKey: "AIzaSyCZWcYv5yX0U-oPx9ilh5LbtWvUCOLfRUY",
          authDomain: "marmaris-sayaci.firebaseapp.com",
          projectId: "marmaris-sayaci",
          storageBucket: "marmaris-sayaci.firebasestorage.app",
          messagingSenderId: "841876333515",
          appId: "1:841876333515:web:08f429048f97268f2a4c4e",
          measurementId: "G-5LW4P8L5C4"
        };
        
        // appId'yi config nesnesinden otomatik olarak al
        const appId = firebaseConfig.projectId || 'marmaris-sayac-default';
        
        // initialAuthToken, kendi sitenizde bulunmayacağı için 'null' olmalı.
        // Kod 'null' olduğunda otomatik olarak 'signInAnonymously' (anonim giriş) yapacaktır.
        const initialAuthToken = null; 

        // Sayaç isimleri ve ID'ler
        const counterIds = ["sari", "kutli", "baskan", "ogir", "eno"];
        
        let db, auth;
        let userId = null;
        let countersDocRef; // Sayaç belgesinin referansı

        // DOM Elementleri
        const loadingIndicator = document.getElementById('loading');
        const counterElements = {};
        const buttonElements = {};

        counterIds.forEach(id => {
            counterElements[id] = document.getElementById(`counter-${id}`);
            buttonElements[id] = document.getElementById(`btn-${id}`);
        });

        // --- TEMEL FONKSİYONLAR ---

        /**
         * Sayaçları GUI üzerinde günceller.
         * @param {object} counts - Firestore'dan gelen sayaç verisi (örn: {sari: 10, kutli: 5})
         */
        function updateUICounters(counts) {
            if (!counts) return;

            counterIds.forEach(id => {
                if (counterElements[id]) {
                    counterElements[id].textContent = counts[id] || 0;
                }
            });
        }

        /**
         * Firestore'da ilgili sayacı 1 arttırır.
         * @param {string} counterId - Arttırılacak sayacın ID'si (örn: "sari")
         */
        async function incrementCounter(counterId) {
            if (!countersDocRef) return;

            try {
                // 'updateDoc' ve 'increment' kullanarak atomik olarak arttır
                // Not: Alan adında tire (-) kullanamayız, bu yüzden ID'leri anahtar olarak kullanıyoruz.
                // Örn: { sari: increment(1) }
                const updates = {};
                updates[counterId] = increment(1);
                
                await updateDoc(countersDocRef, updates);
            } catch (error) {
                console.error(`Sayaç (${counterId}) güncellenirken hata oluştu: `, error);
                // Eğer belge bulunamazsa (ilk defa çalışıyorsa), setDoc ile yeniden oluşturmayı dene
                if (error.code === 'not-found') {
                    await initializeCounters();
                }
            }
        }

        /**
         * Veritabanında sayaç belgesini 0'dan başlatır.
         */
        async function initializeCounters() {
            if (!countersDocRef) return;
            
            console.log("Sayaç belgesi başlatılıyor...");
            const initialData = {
                sari: 0,
                kutli: 0,
                baskan: 0,
                ogir: 0,
                eno: 0,
                createdAt: serverTimestamp() // İlk oluşturulma zamanı
            };
            
            try {
                // 'setDoc' ile 'merge: true' kullanarak var olan veriyi koru, eksikleri ekle
                await setDoc(countersDocRef, initialData, { merge: true });
            } catch (error) {
                console.error("Sayaçlar başlatılırken hata: ", error);
            }
        }

        /**
         * Firestore veritabanını ve sayaçları dinlemeyi başlatır.
         */
        function setupFirestoreListeners() {
            if (!userId) return;

            // Herkesin aynı veriyi görmesi için 'public' yolu kullanıyoruz.
            const docPath = `artifacts/${appId}/public/data/counters/allCounters`;
            countersDocRef = doc(db, docPath);

            // Değişiklikleri anlık olarak dinle
            onSnapshot(countersDocRef, 
                (docSnap) => {
                    loadingIndicator.style.display = 'none'; // Yükleme bitti
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        updateUICounters(data);
                    } else {
                        // Belge (document) yoksa, tüm sayaçları 0'dan başlat
                        console.log("Sayaç belgesi bulunamadı, yeniden oluşturuluyor...");
                        initializeCounters();
                        updateUICounters({}); // GUI'yi 0'la
                    }
                },
                (error) => {
                    console.error("Firestore dinlenirken hata: ", error);
                    loadingIndicator.textContent = "Veritabanı bağlantı hatası.";
                }
            );
        }

        /**
         * Firebase bağlantısını ve kimlik doğrulamasını başlatır.
         */
        async function initializeFirebase() {
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase yapılandırması bulunamadı.");
                loadingIndicator.textContent = "Uygulama yapılandırması eksik.";
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Hata ayıklama için

                // Auth durumunu dinle
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Kullanıcı doğrulandı:", user.uid);
                        userId = user.uid;
                        // Kullanıcı oturum açtıktan sonra Firestore dinleyicilerini başlat
                        setupFirestoreListeners();
                    } else {
                        console.log("Kullanıcı oturumu kapalı.");
                        userId = null;
                    }
                });

                // Oturum açma işlemi
                // Kendi sitemizde 'initialAuthToken' null olacak ve 'signInAnonymously' çalışacak
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    console.log("Anonim olarak oturum açılıyor...");
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Firebase başlatılırken hata: ", error);
                loadingIndicator.textContent = "Uygulama başlatılamadı.";
            }
        }

        // --- UYGULAMAYI BAŞLAT ---

        // Butonlara tıklama olaylarını ekle
        counterIds.forEach(id => {
            if (buttonElements[id]) {
                buttonElements[id].addEventListener('click', () => {
                    incrementCounter(id);
                });
            }
        });

        // Firebase'i başlat
        initializeFirebase();

    </script>
</body>
</html>

